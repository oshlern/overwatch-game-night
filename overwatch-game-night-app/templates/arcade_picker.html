{% extends "base.html" %}

{% block title %}Arcade Picker - Overwatch Game Night{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-dice text-warning"></i>
                Arcade Game Picker
            </h2>
        </div>
    </div>

    <div class="row">
        <!-- Top Row: Selector Buttons and Game History -->
        <div class="row mb-4">
            <!-- Game Mode Selection Buttons -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-gamepad"></i>
                            Game Mode Selection
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="selectModeType('chefs-choice')" id="chefs-choice-btn">
                                    <i class="fas fa-star"></i> Chef's Choice
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="selectModeType('feeling-lucky')" id="feeling-lucky-btn">
                                    <i class="fas fa-dice"></i> I'm Feeling Lucky
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-info w-100" onclick="selectModeType('all-games')" id="all-games-btn">
                                    <i class="fas fa-list"></i> All Games
                                </button>
                            </div>
                        </div>

                        <!-- Player Count Filter and Options -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="player-count-filter" class="form-label small">Filter by Player Count:</label>
                                <input type="number" class="form-control form-control-sm" id="player-count-filter" min="1" max="12" onchange="updatePlayerCountFilter()">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="allow-spectators" onchange="toggleAllowSpectators()">
                                    <label class="form-check-label small" for="allow-spectators">
                                        Allow Spectators
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Animation Area -->
                        <div id="animation-area" class="text-center mb-3" style="min-height: 100px;">
                            <!-- Animation content will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game History -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history"></i>
                            Game History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="game-history" style="max-height: 300px; overflow-y: auto;">
                            <!-- Game history will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selected Game Display -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="selected-game" class="mb-4" style="display: none;">
                    <div class="alert alert-success">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 id="game-name" class="mb-2"></h4>
                                <p id="game-description" class="mb-2"></p>
                                <small id="game-details" class="text-muted"></small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div id="game-icon" class="display-1 mb-2"></div>
                                <button class="btn btn-success" onclick="logSelectedGame()" id="log-game-btn">
                                    <i class="fas fa-save"></i> Play This
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Mode Grid -->
        <div class="row">
            <div class="col-12">
                <div id="gamemode-grid" class="row">
                    <!-- Game modes will be displayed here -->
                </div>
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let availableGames = [];
let gameHistory = [];
let currentSelectedGame = null;
let currentModeType = null;
let isAnimating = false;
let playerCountFilter = null;
let allowSpectators = false;

// Default fallback icons for games without icons in JSON
const defaultGameIcons = ['ðŸŽ®', 'ðŸŽ¯', 'ðŸŽ²', 'ðŸŽª', 'ðŸŽ¨', 'ðŸŽ­', 'ðŸŽª', 'ðŸŽŠ'];

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGames();
    loadGameHistory();
    updatePlayerCountInput();
});

function updatePlayerCountInput() {
    // Wait for activePlayers to be loaded from base.html
    setTimeout(() => {
        const activePlayerCount = Object.values(activePlayers).filter(player => player.status === 'active').length;
        document.getElementById('player-count-filter').value = activePlayerCount;
        playerCountFilter = activePlayerCount;
    }, 100);
}

function updatePlayerCountFilter() {
    const input = document.getElementById('player-count-filter');
    playerCountFilter = parseInt(input.value) || null;

    // Re-apply current filter if a mode is selected
    if (currentModeType) {
        selectModeType(currentModeType);
    }
}

// Remove duplicate player loading functions since they're in base.html

async function loadGames() {
    try {
        const response = await fetch('/api/gamemodes');
        if (response.ok) {
            availableGames = await response.json();
            console.log('Loaded games:', availableGames.length);
        } else {
            console.error('Failed to load games:', response.status);
            showAlert('Failed to load games', 'warning');
        }
    } catch (error) {
        console.error('Error loading games:', error);
        showAlert('Error loading games: ' + error.message, 'danger');
    }
}

async function loadGameHistory() {
    try {
        const response = await fetch('/api/games-history');
        if (response.ok) {
            gameHistory = await response.json();
            displayGameHistory();
        }
    } catch (error) {
        console.error('Error loading game history:', error);
    }
}

function selectModeType(type) {
    if (isAnimating) return;

    // Reset button states
    document.querySelectorAll('[id$="-btn"]').forEach(btn => {
        btn.classList.remove('btn-primary', 'btn-warning', 'btn-info');
        btn.classList.add('btn-outline-primary', 'btn-outline-warning', 'btn-outline-info');
    });

    currentModeType = type;
    const grid = document.getElementById('gamemode-grid');

    if (type === 'chefs-choice') {
        document.getElementById('chefs-choice-btn').classList.remove('btn-outline-primary');
        document.getElementById('chefs-choice-btn').classList.add('btn-primary');
        displayChefsChoice();
    } else if (type === 'feeling-lucky') {
        document.getElementById('feeling-lucky-btn').classList.remove('btn-outline-warning');
        document.getElementById('feeling-lucky-btn').classList.add('btn-warning');
        animateFeelingLucky();
    } else if (type === 'all-games') {
        document.getElementById('all-games-btn').classList.remove('btn-outline-info');
        document.getElementById('all-games-btn').classList.add('btn-info');
        displayAllGames();
    }
}

function displayChefsChoice() {
    const chefsChoiceGames = availableGames.filter(game => game.chefRecommended);
    displayGameGrid(filterGamesByPlayerCount(chefsChoiceGames));
}

function animateFeelingLucky() {
    if (isAnimating) return;
    isAnimating = true;

    const animationArea = document.getElementById('animation-area');
    const playerCount = playerCountFilter || Object.values(activePlayers).filter(player => player.status === 'active').length;

    // Filter games suitable for current player count
    const suitableGames = filterGamesByPlayerCount(availableGames, playerCount);

    // Select 3 random games from suitable games
    const selectedGames = [];
    const gamesCopy = [...suitableGames];
    for (let i = 0; i < 3 && gamesCopy.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * gamesCopy.length);
        selectedGames.push(gamesCopy.splice(randomIndex, 1)[0]);
    }

    let animationStep = 0;
    const totalSteps = 30;

    function animateStep() {
        if (animationStep < totalSteps) {
            // Show random icons during animation
            animationArea.innerHTML = `
                <div class="display-1 mb-3">
                    ${getRandomIcon()} ${getRandomIcon()} ${getRandomIcon()}
                </div>
                <p class="text-muted">Selecting random games...</p>
            `;

            animationStep++;
            const delay = 50 + (animationStep * 10); // Slow down over time
            setTimeout(animateStep, delay);
        } else {
            // Animation complete, clear animation area and show the 3 selected games as cards
            animationArea.innerHTML = '';
            displayGameGrid(selectedGames);
            isAnimating = false;
        }
    }

    animateStep();
}

function getRandomIcon() {
    return defaultGameIcons[Math.floor(Math.random() * defaultGameIcons.length)];
}

function displayAllGames() {
    displayGameGrid(filterGamesByPlayerCount(availableGames));
}

function filterGamesByPlayerCount(games, count = null) {
    const playerCount = count || playerCountFilter || Object.values(activePlayers).filter(player => player.status === 'active').length;

    return games.filter(game => {
        if (!game.playerNums || game.playerNums.length === 0) return true;

        // Check if exact player count is supported
        if (game.playerNums.includes(playerCount)) return true;

        // If allow spectators is enabled, check if player count exceeds max supported
        if (allowSpectators && playerCount > Math.max(...game.playerNums)) return true;

        return false;
    });
}

function toggleAllowSpectators() {
    allowSpectators = document.getElementById('allow-spectators').checked;

    // Re-apply current filter if a mode is selected
    if (currentModeType) {
        selectModeType(currentModeType);
    }
}

function displayGameGrid(games) {
    const grid = document.getElementById('gamemode-grid');

    if (games.length === 0) {
        grid.innerHTML = '<div class="col-12"><p class="text-muted text-center">No games available.</p></div>';
        return;
    }

    grid.innerHTML = games.map(game => {
        const icon = game.icon || 'ðŸŽ®';
        return `
            <div class="col-md-4 col-lg-3 mb-3">
                <div class="card h-100 game-card" onclick="selectGame(${JSON.stringify(game).replace(/"/g, '&quot;')})">
                    <div class="card-body text-center">
                        <div class="display-4 mb-2">${icon}</div>
                        <h6 class="card-title">${game.name}</h6>
                        ${game.description ? `<p class="card-text small text-muted">${game.description}</p>` : ''}
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> ${game.recommendedTime || 10} min<br>
                            <i class="fas fa-users"></i> ${game.players || 'Any'}
                        </small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); copyGameCode('${game.code}')" title="Copy game code">
                                <i class="fas fa-copy"></i> ${game.code}
                            </button>
                            <button class="btn btn-sm btn-outline-primary ms-1" onclick="event.stopPropagation(); openWorkshopCode('${game.code}')" title="View on Workshop">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function selectGame(game) {
    currentSelectedGame = game;
    const icon = game.icon || 'ðŸŽ®';

    document.getElementById('game-name').textContent = game.name;
    document.getElementById('game-description').textContent = game.description || '';
    document.getElementById('game-icon').textContent = icon;

    let detailsText = `Time: ${game.recommendedTime || 10} min | Players: ${game.players || 'Any'}`;
    document.getElementById('game-details').innerHTML = `
        ${detailsText}<br>
        <button class="btn btn-sm btn-outline-light mt-2 me-2" onclick="copyGameCode('${game.code}')" title="Copy game code">
            <i class="fas fa-copy"></i> Code: ${game.code}
        </button>
        <button class="btn btn-sm btn-outline-light mt-2" onclick="openWorkshopCode('${game.code}')" title="View on Workshop">
            <i class="fas fa-external-link-alt"></i> Workshop
        </button>
    `;

    document.getElementById('selected-game').style.display = 'block';

    // Scroll to selected game
    document.getElementById('selected-game').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

async function logSelectedGame() {
    if (!currentSelectedGame) return;

    const gameData = {
        ...currentSelectedGame,
        timestamp: new Date().toISOString(),
        players: Object.values(activePlayers).filter(player => player.status === 'active').map(player => player.name)
    };

    try {
        const response = await fetch('/api/games-history', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gameData)
        });

        if (response.ok) {
            showAlert('Game logged successfully!', 'success');
            loadGameHistory();
            document.getElementById('selected-game').style.display = 'none';
            currentSelectedGame = null;
        }
    } catch (error) {
        showAlert('Error logging game: ' + error.message, 'danger');
    }
}

function displayGameHistory() {
    const historyDiv = document.getElementById('game-history');

    if (gameHistory.length === 0) {
        historyDiv.innerHTML = '<p class="text-muted text-center">No games played yet.</p>';
        return;
    }

    const sortedHistory = gameHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    historyDiv.innerHTML = `
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Game</th>
                        <th>Code</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedHistory.slice(0, 10).map(game => {
                        const icon = game.icon || 'ðŸŽ®';
                        return `
                            <tr>
                                <td>${new Date(game.timestamp).toLocaleDateString()}</td>
                                <td>${icon} ${game.name || game.title}</td>
                                <td><code style="cursor: pointer;" onclick="copyGameCode('${game.code}')" title="Click to copy">${game.code}</code></td>
                                <td><span class="badge bg-secondary">${game.category || 'Workshop'}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function copyGameCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        showToast('Code copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy code: ', err);
        showToast('Failed to copy code', 'error');
    });
}

function openWorkshopCode(code) {
    const url = `https://workshop.codes/${code}`;
    window.open(url, '_blank');
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 end-0 m-3 alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>

<style>
.game-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.game-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

#feeling-lucky-btn.btn-warning {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
</style>
{% endblock %}
