{% extends "base.html" %}

{% block title %}Arcade Picker - Overwatch Game Night{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-dice text-warning"></i>
                Arcade Game Picker
            </h2>
        </div>
    </div>

    <div class="row">
        <!-- Main Content Area -->
        <div class="col-lg-8">
            <!-- Game Mode Selection Buttons -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-gamepad"></i>
                        Game Mode Selection
                    </h5>
                </div>
                <div class="card-body">

                    <div class="row mb-3">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-primary w-100" onclick="selectModeType('chefs-choice')" id="chefs-choice-btn">
                                <i class="fas fa-star"></i> Chef's Choice
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-warning w-100" onclick="selectModeType('feeling-lucky')" id="feeling-lucky-btn">
                                <i class="fas fa-dice"></i> I'm Feeling Lucky
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-info w-100" onclick="selectModeType('all-games')" id="all-games-btn">
                                <i class="fas fa-list"></i> All Games
                            </button>
                        </div>
                    </div>

                    <!-- Player Count Filter and Options -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="player-count-filter" class="form-label small">Filter by Player Count:</label>
                            <input type="number" class="form-control form-control-sm" id="player-count-filter" min="1" max="12" onchange="updatePlayerCountFilter()">
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="allow-spectators" onchange="toggleAllowSpectators()">
                                <label class="form-check-label small" for="allow-spectators">
                                    Allow Spectators
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="shuffle-games" checked onchange="toggleShuffle()">
                                <label class="form-check-label small" for="shuffle-games">
                                    Shuffle Games
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Animation Area -->
                    <div id="animation-area" class="text-center mb-3" style="min-height: 100px;">
                        <!-- Animation content will be displayed here -->
                    </div>

                    <!-- Current Status Display -->
                    <div id="current-status" class="mb-3" style="display: none;">
                        <div class="alert alert-dark mb-3" style="background: rgba(20, 20, 20, 0.9); border: 2px solid #dc3545; color: #fff;">
                            <div class="row g-3">
                                <div class="col-12 col-lg-6" id="current-leader-display" style="display: none;">
                                    <strong><i class="fas fa-crown text-warning"></i> Current Leader:</strong>
                                    <div id="current-leader-name" class="player-name mt-1"></div>
                                </div>
                                <div class="col-12 col-lg-6" id="current-game-display" style="display: none;">
                                    <strong><i class="fas fa-gamepad text-danger"></i> Selected Game:</strong>
                                    <div id="current-game-name" style="font-family: 'Press Start 2P', monospace; font-size: 14px; margin: 8px 0;"></div>
                                    <div id="current-game-description" class="mb-2 small text-muted" style="opacity: 0.7;"></div>
                                    <div id="current-game-details" class="small"></div>
                                    <div id="current-game-code" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selected Game Display -->
            <div class="row mb-4">
                <div class="col-12">
                    <div id="selected-game" class="mb-4" style="display: none;">
                        <div class="alert alert-dark" style="background: rgba(15, 15, 15, 0.95); border: 2px solid #dc3545; color: #fff;">
                            <div class="row">
                                <div class="col-md-8">
                                    <h4 id="game-name" class="mb-2"></h4>
                                    <p id="game-description" class="mb-2"></p>
                                    <small id="game-details" class="text-muted"></small>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div id="game-icon" class="display-1 mb-2"></div>
                                    <button class="btn btn-success" onclick="logSelectedGame()" id="log-game-btn">
                                        <i class="fas fa-save"></i> Play This
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Mode Grid -->
            <div class="row">
                <div class="col-12">
                    <div id="gamemode-grid" class="row">
                        <!-- Game modes will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Lobby Leader and Game History -->
        <div class="col-lg-4">
            <!-- Lobby Leader -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-crown text-warning"></i>
                        Lobby Leader
                        <button class="btn btn-sm btn-outline-light float-end" onclick="toggleLeaderWheel()" id="toggle-wheel-btn">
                            <i class="fas fa-chevron-down" id="toggle-wheel-icon"></i>
                        </button>
                    </h5>
                </div>
                <div class="card-body text-center collapse" id="leader-wheel-body">
                    <!-- Name Scroller Container -->
                    <div id="scroller-container" class="mb-3">
                        <div class="name-scroller">
                            <div class="scroller-window">
                                <div id="name-reel" class="name-reel">
                                    <!-- Player names will be populated here -->
                                </div>
                                <div class="ticker-marker">
                                    <div class="ticker-arrow"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Spin Button -->
                    <button id="spin-btn" class="btn btn-warning btn-lg mb-3" onclick="spinNames()" style="width: 100%; font-size: 0.9rem;">
                        <i class="fas fa-dice"></i> Pick Leader!
                    </button>

                    <!-- Result Display -->
                    <div id="leader-result" style="display: none;">
                        <div class="alert alert-warning text-center">
                            <h4 class="mb-2">🎉 Lobby Leader 🎉</h4>
                            <div id="selected-leader" class="display-6 player-name" style="color: var(--arcade-dark); text-shadow: none;"></div>
                            <button class="btn btn-sm btn-outline-dark mt-2" onclick="resetScroller()">
                                <i class="fas fa-redo"></i> Pick Again
                            </button>
                        </div>
                    </div>

                    <!-- Active Players Count -->
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-users"></i>
                            <span id="active-player-count">0</span> active players
                        </small>
                    </div>
                </div>
            </div>

            <!-- Game History -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history"></i>
                        Game History
                    </h5>
                </div>
                <div class="card-body">
                    <div id="game-history" style="max-height: 300px; overflow-y: auto;">
                        <!-- Game history will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="text-center mt-4">
    <small class="text-muted">
        <a href="https://docs.google.com/spreadsheets/d/1NtYitzAWXM7XDliqDVqoPfFvGc9wL2Yl6HTBtEGCQwo/edit?pli=1&gid=1428733039#gid=1428733039" target="_blank" class="text-muted" style="text-decoration: none;">
            <i class="fas fa-map"></i> Mercy Parkour Map List
        </a>
    </small>
</div>
{% endblock %}

{% block scripts %}
<script>
let availableGames = [];
let gameHistory = [];
let currentSelectedGame = null;
let currentModeType = 'all-games';
let isAnimating = false;
let playerCountFilter = null;
let allowSpectators = false;
let shuffleGames = true;

// Lobby Leader Scroller Variables
let scrollerPlayers = [];
let isSpinning = false;
let scrollAnimation = null;
let currentScrollPosition = 0;

// Default fallback icons for games without icons in JSON
const defaultGameIcons = ['🎮', '🎯', '🎲', '🎪', '🎨', '🎭', '🎪', '🎊'];

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGames();
    loadGameHistory();
    updatePlayerCountInput();
    initializeScroller();
    initializeSocketIO();
    // Show all games by default
    setTimeout(() => {
        selectModeType('all-games');
    }, 200);
});

function updatePlayerCountInput() {
    // Wait for activePlayers to be loaded from base.html
    setTimeout(() => {
        const activePlayerCount = Object.values(activePlayers).filter(player => player.status === 'active').length;
        document.getElementById('player-count-filter').value = activePlayerCount;
        playerCountFilter = activePlayerCount;
    }, 100);
}

function updatePlayerCountFilter() {
    const input = document.getElementById('player-count-filter');
    playerCountFilter = parseInt(input.value) || null;

    // Re-apply current filter if a mode is selected
    if (currentModeType) {
        selectModeType(currentModeType);
    }
}

// Remove duplicate player loading functions since they're in base.html

async function loadGames() {
    try {
        const response = await fetch('/api/gamemodes');
        if (response.ok) {
            availableGames = await response.json();
            console.log('Loaded games:', availableGames.length);
        } else {
            console.error('Failed to load games:', response.status);
            showAlert('Failed to load games', 'warning');
        }
    } catch (error) {
        console.error('Error loading games:', error);
        showAlert('Error loading games: ' + error.message, 'danger');
    }
}

async function loadGameHistory() {
    try {
        const response = await fetch('/api/games-history');
        if (response.ok) {
            gameHistory = await response.json();
            displayGameHistory();
        }
    } catch (error) {
        console.error('Error loading game history:', error);
    }
}

function selectModeType(type) {
    if (isAnimating) return;

    // Reset button states
    document.querySelectorAll('[id$="-btn"]').forEach(btn => {
        btn.classList.remove('btn-primary', 'btn-warning', 'btn-info');
        btn.classList.add('btn-outline-primary', 'btn-outline-warning', 'btn-outline-info');
    });

    currentModeType = type;
    const grid = document.getElementById('gamemode-grid');

    if (type === 'chefs-choice') {
        document.getElementById('chefs-choice-btn').classList.remove('btn-outline-primary');
        document.getElementById('chefs-choice-btn').classList.add('btn-primary');
        displayChefsChoice();
    } else if (type === 'feeling-lucky') {
        document.getElementById('feeling-lucky-btn').classList.remove('btn-outline-warning');
        document.getElementById('feeling-lucky-btn').classList.add('btn-warning');
        animateFeelingLucky();
    } else if (type === 'all-games') {
        document.getElementById('all-games-btn').classList.remove('btn-outline-info');
        document.getElementById('all-games-btn').classList.add('btn-info');
        displayAllGames();
    }
}

function displayChefsChoice() {
    const chefsChoiceGames = availableGames.filter(game => game.chefRecommended);
    displayGameGrid(filterGamesByPlayerCount(chefsChoiceGames));
}

function animateFeelingLucky() {
    if (isAnimating) return;
    isAnimating = true;

    const animationArea = document.getElementById('animation-area');
    const playerCount = playerCountFilter || Object.values(activePlayers).filter(player => player.status === 'active').length;

    // Filter games suitable for current player count
    const suitableGames = filterGamesByPlayerCount(availableGames, playerCount);

    // Select 3 random games from suitable games
    const selectedGames = [];
    const gamesCopy = [...suitableGames];
    for (let i = 0; i < 3 && gamesCopy.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * gamesCopy.length);
        selectedGames.push(gamesCopy.splice(randomIndex, 1)[0]);
    }

    let animationStep = 0;
    const totalSteps = 30;

    function animateStep() {
        if (animationStep < totalSteps) {
            // Show random icons during animation
            animationArea.innerHTML = `
                <div class="display-1 mb-3">
                    ${getRandomIcon()} ${getRandomIcon()} ${getRandomIcon()}
                </div>
                <p class="text-muted">Selecting random games...</p>
            `;

            animationStep++;
            const delay = 50 + (animationStep * 10); // Slow down over time
            setTimeout(animateStep, delay);
        } else {
            // Animation complete, clear animation area and show the 3 selected games as cards
            animationArea.innerHTML = '';
            displayGameGrid(selectedGames);
            isAnimating = false;
        }
    }

    animateStep();
}

function getRandomIcon() {
    return defaultGameIcons[Math.floor(Math.random() * defaultGameIcons.length)];
}

function displayAllGames() {
    displayGameGrid(filterGamesByPlayerCount(availableGames));
}

function filterGamesByPlayerCount(games, count = null) {
    const playerCount = count || playerCountFilter || Object.values(activePlayers).filter(player => player.status === 'active').length;

    return games.filter(game => {
        if (!game.playerNums || game.playerNums.length === 0) return true;

        // Check if exact player count is supported
        if (game.playerNums.includes(playerCount)) return true;

        // If allow spectators is enabled, check if player count exceeds max supported
        if (allowSpectators && playerCount > Math.max(...game.playerNums)) return true;

        return false;
    });
}

function toggleAllowSpectators() {
    allowSpectators = document.getElementById('allow-spectators').checked;

    // Re-apply current filter if a mode is selected
    if (currentModeType) {
        selectModeType(currentModeType);
    }
}

function toggleShuffle() {
    shuffleGames = document.getElementById('shuffle-games').checked;

    // Re-apply current filter if a mode is selected
    if (currentModeType) {
        selectModeType(currentModeType);
    }
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function displayGameGrid(games) {
    const grid = document.getElementById('gamemode-grid');

    if (games.length === 0) {
        grid.innerHTML = '<div class="col-12"><p class="text-muted text-center">No games available.</p></div>';
        return;
    }

    // Shuffle games if option is enabled
    const displayGames = shuffleGames ? shuffleArray(games) : games;

    grid.innerHTML = displayGames.map(game => {
        const icon = game.icon || '🎮';
        return `
            <div class="col-md-4 col-lg-3 mb-3">
                <div class="card h-100 game-card" onclick="selectGame(${JSON.stringify(game).replace(/"/g, '&quot;')})">
                    <div class="card-body text-center">
                        <div class="display-4 mb-2">${icon}</div>
                        <h6 class="card-title">${game.name}</h6>
                        ${game.description ? `<p class="card-text small text-muted">${game.description}</p>` : ''}
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> ${game.recommendedTime || 10} min<br>
                            <i class="fas fa-users"></i> ${game.players || 'Any'}
                        </small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); copyGameCode('${game.code}')" title="Copy game code">
                                <i class="fas fa-copy"></i> ${game.code}
                            </button>
                            <button class="btn btn-sm btn-outline-primary ms-1" onclick="event.stopPropagation(); openWorkshopCode('${game.code}')" title="View on Workshop">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function selectGame(game) {
    currentSelectedGame = game;
    const icon = game.icon || '🎮';

    document.getElementById('game-name').textContent = game.name;
    document.getElementById('game-description').textContent = game.description || '';
    document.getElementById('game-icon').textContent = icon;

    let detailsText = `Time: ${game.recommendedTime || 10} min | Players: ${game.players || 'Any'}`;
    document.getElementById('game-details').innerHTML = `
        ${detailsText}<br>
        <button class="btn btn-sm btn-outline-light mt-2 me-2" onclick="copyGameCode('${game.code}')" title="Copy game code">
            <i class="fas fa-copy"></i> Code: ${game.code}
        </button>
        <button class="btn btn-sm btn-outline-light mt-2" onclick="openWorkshopCode('${game.code}')" title="View on Workshop">
            <i class="fas fa-external-link-alt"></i> Workshop
        </button>
    `;

    document.getElementById('selected-game').style.display = 'block';

    // Update current game display
    updateCurrentGameDisplay(game.name, true); // true = broadcast

    // Scroll to selected game
    document.getElementById('selected-game').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

async function logSelectedGame() {
    if (!currentSelectedGame) return;

    const gameData = {
        ...currentSelectedGame,
        timestamp: new Date().toISOString(),
        players: Object.values(activePlayers).filter(player => player.status === 'active').map(player => player.name)
    };

    try {
        const response = await fetch('/api/games-history', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gameData)
        });

        if (response.ok) {
            showAlert('Game logged successfully!', 'success');
            loadGameHistory();
            document.getElementById('selected-game').style.display = 'none';
            currentSelectedGame = null;
        }
    } catch (error) {
        showAlert('Error logging game: ' + error.message, 'danger');
    }
}

function displayGameHistory() {
    const historyDiv = document.getElementById('game-history');

    if (gameHistory.length === 0) {
        historyDiv.innerHTML = '<p class="text-muted text-center">No games played yet.</p>';
        return;
    }

    const sortedHistory = gameHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    historyDiv.innerHTML = `
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Game</th>
                        <th>Code</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedHistory.slice(0, 10).map(game => {
                        const icon = game.icon || '🎮';
                        return `
                            <tr>
                                <td>${new Date(game.timestamp).toLocaleDateString()}</td>
                                <td>${icon} ${game.name || game.title}</td>
                                <td><code style="cursor: pointer;" onclick="copyGameCode('${game.code}')" title="Click to copy">${game.code}</code></td>
                                <td><span class="badge bg-secondary">${game.category || 'Workshop'}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function copyGameCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        showToast('Code copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy code: ', err);
        showToast('Failed to copy code', 'error');
    });
}

function openWorkshopCode(code) {
    const url = `https://workshop.codes/${code}`;
    window.open(url, '_blank');
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 end-0 m-3 alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// ===== LOBBY LEADER SCROLLER FUNCTIONS =====

function initializeScroller() {
    updateScrollerPlayers();
    populateScroller();
    startInfiniteScroll();

    // Update scroller when players change
    const originalDisplayActivePlayers = window.displayActivePlayers;
    window.displayActivePlayers = function() {
        if (originalDisplayActivePlayers) {
            originalDisplayActivePlayers();
        }
        updateScrollerPlayers();
        populateScroller();
    };
}

function updateScrollerPlayers() {
    // Get active players (not AFK)
    scrollerPlayers = Object.values(activePlayers).filter(player =>
        player.status !== 'afk'
    ).map(player => player.bnet);

    // Update active player count display
    const countElement = document.getElementById('active-player-count');
    if (countElement) {
        countElement.textContent = scrollerPlayers.length;
    }

    // Show/hide spin button based on player count
    const spinBtn = document.getElementById('spin-btn');
    if (spinBtn) {
        if (scrollerPlayers.length < 2) {
            spinBtn.disabled = true;
            spinBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Need 2+ Players';
        } else {
            spinBtn.disabled = false;
            spinBtn.innerHTML = '<i class="fas fa-dice"></i> Pick Leader!';
        }
    }
}

function populateScroller() {
    const reel = document.getElementById('name-reel');
    if (!reel || scrollerPlayers.length === 0) {
        if (reel) {
            reel.innerHTML = '<div class="name-item">No Active Players</div>';
        }
        return;
    }

    // Create infinite loop of names
    const items = [];
    for (let i = 0; i < 50; i++) { // More repetitions for smoother infinite scroll
        scrollerPlayers.forEach(player => {
            items.push(`<div class="name-item">${player}</div>`);
        });
    }

    reel.innerHTML = items.join('');
}

function startInfiniteScroll() {
    const reel = document.getElementById('name-reel');
    if (!reel || isSpinning) return;

    // Start slow continuous scrolling
    currentScrollPosition = 0;

    function scroll() {
        if (!isSpinning) {
            currentScrollPosition += 1.67; // 3x slower than before (was 5, now 1.67)
            reel.style.transform = `translateY(-${currentScrollPosition}px)`;

            // Reset position when we've scrolled through one full cycle
            const itemHeight = 50;
            const cycleHeight = scrollerPlayers.length * itemHeight;
            if (currentScrollPosition >= cycleHeight) {
                currentScrollPosition = 0;
            }
        }

        if (!isSpinning) {
            requestAnimationFrame(scroll);
        }
    }

    scroll();
}

function spinNames() {
    if (isSpinning || scrollerPlayers.length < 2) return;

    isSpinning = true;
    const spinBtn = document.getElementById('spin-btn');
    const reel = document.getElementById('name-reel');

    spinBtn.disabled = true;
    spinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Picking...';

    // Hide previous result
    document.getElementById('leader-result').style.display = 'none';

    // Animation parameters
    const duration = 4000 + Math.random() * 2500; // 4-7 seconds
    const startTime = Date.now();
    const initialSpeed = 20; // Initial speed
    const t_final = duration / 1000; // Convert to seconds for cleaner math

    function animateScroll() {
        const elapsed = Date.now() - startTime;
        const progress = elapsed / duration;

        if (progress < 1) {
            // Cubic deceleration: v ∝ (t_final^3 - t^3)
            const speed = initialSpeed * (1 - progress) * (1 - progress) * (1 -progress);
            currentScrollPosition += speed;

            reel.style.transform = `translateY(-${currentScrollPosition}px)`;

            // Reset position for infinite loop
            const itemHeight = 50;
            const cycleHeight = scrollerPlayers.length * itemHeight;
            if (currentScrollPosition >= cycleHeight) {
                currentScrollPosition = 0;
            }

            requestAnimationFrame(animateScroll);
        } else {
            // Stop and select winner
            const itemHeight = 50;
            const tickerTop = 100; // px
            const tickerCenter = tickerTop + itemHeight / 2; // 125px
            // Select the name item whose center aligns with the center of the ticker marker
            const selectedIndex = Math.floor((currentScrollPosition + tickerCenter) / itemHeight) % scrollerPlayers.length;
            const winner = scrollerPlayers[selectedIndex];

            // Show result
            document.getElementById('selected-leader').textContent = winner;
            document.getElementById('leader-result').style.display = 'block';

            // Reset button
            spinBtn.disabled = false;
            spinBtn.innerHTML = '<i class="fas fa-dice"></i> Pick Leader!';

            isSpinning = false;

            // Add celebration effect
            showToast(`🎉 ${winner} is the new Lobby Leader! 🎉`, 'success');
        }
    }

    animateScroll();
}

function resetScroller() {
    document.getElementById('leader-result').style.display = 'none';
    currentScrollPosition = 0;
    const reel = document.getElementById('name-reel');
    reel.style.transform = 'translateY(0)';

    // Restart infinite scroll when resetting
    if (!isSpinning) {
        startInfiniteScroll();
    }
}

// ===== LOBBY LEADER WHEEL SYNCHRONIZATION =====

let socket = null;
let isWheelExpanded = false;
let syncedAnimationId = null;
let currentLeader = null;
let currentSelectedGameName = null;

function initializeSocketIO() {
    socket = io();

    socket.on('connect', function() {
        socket.emit('join_arcade_picker');
    });

    socket.on('wheel_state_update', function(data) {
        updateWheelState(data.expanded, false); // false = don't broadcast
    });

    socket.on('wheel_spin_sync', function(data) {
        if (data.action === 'start') {
            syncSpinStart(data.duration, data.startTime, data.initialSpeed, data.startPosition);
        } else if (data.action === 'result') {
            syncSpinResult(data.winner);
        }
    });

    socket.on('game_selected_sync', function(data) {
        if (data.gameData) {
            currentSelectedGame = data.gameData;
        }
        updateCurrentGameDisplay(data.gameName, false); // false = don't broadcast
    });

    socket.on('leader_selected_sync', function(data) {
        updateCurrentLeaderDisplay(data.leader, false); // false = don't broadcast
    });
}

function toggleLeaderWheel() {
    isWheelExpanded = !isWheelExpanded;
    updateWheelState(isWheelExpanded, true); // true = broadcast to others
}

function updateWheelState(expanded, shouldBroadcast = false) {
    isWheelExpanded = expanded;
    const wheelBody = document.getElementById('leader-wheel-body');
    const toggleIcon = document.getElementById('toggle-wheel-icon');

    if (expanded) {
        wheelBody.classList.add('show');
        toggleIcon.classList.remove('fa-chevron-down');
        toggleIcon.classList.add('fa-chevron-up');
        // Restart infinite scroll when expanded
        if (!isSpinning) {
            startInfiniteScroll();
        }
    } else {
        wheelBody.classList.remove('show');
        toggleIcon.classList.remove('fa-chevron-up');
        toggleIcon.classList.add('fa-chevron-down');
    }

    if (shouldBroadcast && socket) {
        socket.emit('wheel_state_change', { expanded: expanded });
    }
}

function syncSpinStart(duration, startTime, initialSpeed, startPosition) {
    if (!isWheelExpanded) {
        updateWheelState(true, false); // Expand wheel for all users
    }

    // Start synchronized animation
    isSpinning = true;
    const spinBtn = document.getElementById('spin-btn');
    const reel = document.getElementById('name-reel');

    spinBtn.disabled = true;
    spinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Picking...';

    // Hide previous result
    document.getElementById('leader-result').style.display = 'none';

    // Synchronize starting position
    currentScrollPosition = startPosition || currentScrollPosition;

    // Calculate time offset for synchronization
    const now = Date.now();
    const timeOffset = now - startTime;

    // Adjust starting position based on time offset
    if (timeOffset > 0) {
        // Calculate how much scrolling should have happened during the offset
        const offsetProgress = timeOffset / duration;
        if (offsetProgress < 1) {
            // Simulate the scrolling that should have happened
            for (let t = 0; t < timeOffset; t += 16) { // 16ms per frame
                const progress = (t + timeOffset) / duration;
                if (progress < 1) {
                    const speed = initialSpeed * (1 - progress) * (1 - progress) * (1 - progress);
                    currentScrollPosition += speed;
                }
            }
        }
    }

    function syncedAnimateScroll() {
        const elapsed = Date.now() - startTime;
        const progress = elapsed / duration;

        if (progress < 1) {
            const speed = initialSpeed * (1 - progress) * (1 - progress) * (1 - progress);
            currentScrollPosition += speed;

            reel.style.transform = `translateY(-${currentScrollPosition}px)`;

            const itemHeight = 50;
            const cycleHeight = scrollerPlayers.length * itemHeight;
            if (currentScrollPosition >= cycleHeight) {
                currentScrollPosition = 0;
            }

            syncedAnimationId = requestAnimationFrame(syncedAnimateScroll);
        } else {
            // Animation complete - wait for result from leader
            isSpinning = false;
            syncedAnimationId = null;
        }
    }

    // Start animation if not too late
    if (timeOffset < duration) {
        syncedAnimateScroll();
    }
}

function syncSpinResult(winner) {
    // Stop any ongoing animation
    if (syncedAnimationId) {
        cancelAnimationFrame(syncedAnimationId);
        syncedAnimationId = null;
    }

    // Show the result
    document.getElementById('selected-leader').textContent = winner;
    document.getElementById('leader-result').style.display = 'block';

    // Reset button
    const spinBtn = document.getElementById('spin-btn');
    spinBtn.disabled = false;
    spinBtn.innerHTML = '<i class="fas fa-dice"></i> Pick Leader!';

    isSpinning = false;

    // Update current leader display
    updateCurrentLeaderDisplay(winner, false); // false = don't broadcast

    // Show toast
    showToast(`🎉 ${winner} is the new Lobby Leader! 🎉`, 'success');
}

function updateCurrentLeaderDisplay(leader, shouldBroadcast = false) {
    currentLeader = leader;
    const leaderDisplay = document.getElementById('current-leader-display');
    const leaderName = document.getElementById('current-leader-name');
    const statusDiv = document.getElementById('current-status');

    if (leader) {
        leaderName.textContent = leader;
        leaderDisplay.style.display = 'block';
        statusDiv.style.display = 'block';
    } else {
        leaderDisplay.style.display = 'none';
        if (!currentSelectedGameName) {
            statusDiv.style.display = 'none';
        }
    }

    if (shouldBroadcast && socket) {
        socket.emit('leader_selected', { leader: leader });
    }
}

function updateCurrentGameDisplay(gameName, shouldBroadcast = false) {
    currentSelectedGameName = gameName;
    const gameDisplay = document.getElementById('current-game-display');
    const gameNameDiv = document.getElementById('current-game-name');
    const gameDescription = document.getElementById('current-game-description');
    const gameDetails = document.getElementById('current-game-details');
    const gameCode = document.getElementById('current-game-code');
    const statusDiv = document.getElementById('current-status');

    if (gameName && currentSelectedGame) {
        gameNameDiv.textContent = gameName;

        // Add description
        gameDescription.textContent = currentSelectedGame.description || '';

        // Add game details
        const time = currentSelectedGame.recommendedTime || 10;
        const players = currentSelectedGame.players || 'Any';
        gameDetails.innerHTML = `Time: ${time} min | Players: ${players}`;

        // Add clickable code
        const code = currentSelectedGame.code;
        gameCode.innerHTML = `
            <code style="cursor: pointer; background: rgba(220, 53, 69, 0.2); padding: 4px 8px; border-radius: 4px; border: 1px solid #dc3545; font-family: 'Press Start 2P', monospace; font-weight: bold; font-size: 12px;"
                  onclick="copyGameCode('${code}')" title="Click to copy">${code}</code>
            <button class="btn btn-sm btn-outline-light ms-2" onclick="openWorkshopCode('${code}')" title="View on Workshop">
                <i class="fas fa-external-link-alt"></i>
            </button>
        `;

        gameDisplay.style.display = 'block';
        statusDiv.style.display = 'block';
    } else {
        gameDisplay.style.display = 'none';
        if (!currentLeader) {
            statusDiv.style.display = 'none';
        }
    }

    if (shouldBroadcast && socket) {
        socket.emit('game_selected', {
            gameName: gameName,
            gameData: currentSelectedGame
        });
    }
}

// Override the original spinNames function to broadcast with animation sync
function spinNames() {
    if (isSpinning || scrollerPlayers.length < 2) return;

    // Animation parameters
    const duration = 4000 + Math.random() * 2500; // 4-7 seconds
    const startTime = Date.now();
    const initialSpeed = 20;

    // Broadcast spin start with animation parameters to all users
    if (socket) {
        socket.emit('wheel_spin', {
            action: 'start',
            duration: duration,
            startTime: startTime,
            initialSpeed: initialSpeed
        });
    }

    // Start local animation
    isSpinning = true;
    const spinBtn = document.getElementById('spin-btn');
    const reel = document.getElementById('name-reel');

    spinBtn.disabled = true;
    spinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Picking...';

    // Hide previous result
    document.getElementById('leader-result').style.display = 'none';

    function animateScroll() {
        const elapsed = Date.now() - startTime;
        const progress = elapsed / duration;

        if (progress < 1) {
            const speed = initialSpeed * (1 - progress) * (1 - progress) * (1 - progress);
            currentScrollPosition += speed;

            reel.style.transform = `translateY(-${currentScrollPosition}px)`;

            const itemHeight = 50;
            const cycleHeight = scrollerPlayers.length * itemHeight;
            if (currentScrollPosition >= cycleHeight) {
                currentScrollPosition = 0;
            }

            requestAnimationFrame(animateScroll);
        } else {
            // Stop and select winner
            const itemHeight = 50;
            const tickerTop = 100;
            const tickerCenter = tickerTop + itemHeight / 2;
            const selectedIndex = Math.floor((currentScrollPosition + tickerCenter) / itemHeight) % scrollerPlayers.length;
            const winner = scrollerPlayers[selectedIndex];

            // Broadcast result to all users
            if (socket) {
                socket.emit('wheel_spin', { action: 'result', winner: winner });
            }

            // Show local result
            document.getElementById('selected-leader').textContent = winner;
            document.getElementById('leader-result').style.display = 'block';

            // Reset button
            spinBtn.disabled = false;
            spinBtn.innerHTML = '<i class="fas fa-dice"></i> Pick Leader!';

            isSpinning = false;

            // Update current leader display
            updateCurrentLeaderDisplay(winner, true); // true = broadcast

            // Add celebration effect
            showToast(`🎉 ${winner} is the new Lobby Leader! 🎉`, 'success');
        }
    }

    animateScroll();
}
</script>

<style>
.game-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.game-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

#feeling-lucky-btn.btn-warning {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Lobby Leader Name Scroller Styles */
.name-scroller {
    background: linear-gradient(145deg, #2d1b69, #1a1a2e);
    border: 3px solid var(--arcade-cyan);
    border-radius: 15px;
    padding: 20px;
    box-shadow:
        0 0 20px rgba(0, 255, 255, 0.3),
        inset 0 0 20px rgba(106, 13, 173, 0.2);
}

.scroller-window {
    height: 250px;
    overflow: hidden;
    background: #0a0a1a;
    border: 2px solid var(--arcade-purple);
    border-radius: 10px;
    position: relative;
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
}

.name-reel {
    display: flex;
    flex-direction: column;
    position: relative;
}

.name-item {
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Press Start 2P', monospace;
    font-size: 14px;
    color: var(--arcade-cyan);
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    border-bottom: 1px solid rgba(106, 13, 173, 0.3);
    background: linear-gradient(90deg,
        rgba(106, 13, 173, 0.1) 0%,
        rgba(255, 20, 147, 0.1) 50%,
        rgba(106, 13, 173, 0.1) 100%);
    transition: all 0.3s ease;
}

.name-item:nth-child(even) {
    background: linear-gradient(90deg,
        rgba(0, 255, 255, 0.1) 0%,
        rgba(57, 255, 20, 0.1) 50%,
        rgba(0, 255, 255, 0.1) 100%);
    color: var(--neon-green);
    text-shadow: 0 0 10px rgba(57, 255, 20, 0.5);
}

.ticker-marker {
    position: absolute;
    top: 100px; /* Center position */
    left: -10px;
    right: -10px;
    height: 50px;
    pointer-events: none;
    z-index: 10;
}

.ticker-arrow {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-top: 15px solid transparent;
    border-bottom: 15px solid transparent;
    border-right: 25px solid var(--neon-yellow);
    filter: drop-shadow(0 0 10px rgba(255, 255, 0, 0.8));
    animation: ticker-pulse 1.5s ease-in-out infinite alternate;
}

.ticker-arrow::before {
    content: '';
    position: absolute;
    left: -20px;
    top: -10px;
    width: 20px;
    height: 20px;
    background: var(--neon-yellow);
    border-radius: 50%;
    box-shadow: 0 0 15px rgba(255, 255, 0, 0.6);
}

@keyframes ticker-pulse {
    0% {
        filter: drop-shadow(0 0 10px rgba(255, 255, 0, 0.8));
        transform: translateY(-50%) scale(1);
    }
    100% {
        filter: drop-shadow(0 0 20px rgba(255, 255, 0, 1));
        transform: translateY(-50%) scale(1.1);
    }
}

#leader-result {
    animation: result-appear 0.5s ease-out;
}

@keyframes result-appear {
    0% {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.sticky-top {
    position: sticky !important;
}

/* Mobile responsiveness for scroller */
@media (max-width: 992px) {
    .scroller-window {
        height: 200px;
    }

    .name-item {
        height: 40px;
        font-size: 12px;
    }

    .ticker-marker {
        top: 80px;
    }

    .ticker-arrow {
        border-top: 12px solid transparent;
        border-bottom: 12px solid transparent;
        border-right: 20px solid var(--neon-yellow);
    }
}
</style>
{% endblock %}
